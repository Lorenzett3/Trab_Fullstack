<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Gerenciamento de Pedidos</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Paleta de Cores e Variáveis */
      :root {
        --color-primary: #4caf50; /* Verde Principal */
        --color-secondary: #ffc107; /* Amarelo/Dourado (Acentos) */
        --color-background: #f8f8f8; /* Fundo Claro */
        --color-card: #ffffff; /* Fundo do Cartão/Módulo */
        --color-text-dark: #333333;
        --color-text-light: #555555;
        --color-danger: #d32f2f;
        --color-info: #1976d2;
        --color-table-stripe: #fafafa;
      }

      /* --- Estilo do Tema Escuro --- */
      body[data-theme="dark"] {
        --color-background: #1e1e1e;
        --color-card: #2d2d2d;
        --color-text-dark: #f0f0f0;
        --color-text-light: #b0b0b0;
        --color-table-stripe: #333333;
        --color-primary: #66bb6a; /* Verde mais claro no escuro */
        --color-secondary: #ffd54f;
      }

      body {
        font-family: "Poppins", sans-serif;
        padding: 20px;
        background-color: var(--color-background);
        color: var(--color-text-dark);
        margin: 0;
        transition: background-color 0.3s, color 0.3s;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        margin-bottom: 20px;
      }

      .header button {
        background-color: var(--color-danger);
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        margin-left: 10px; /* Espaçamento entre botões */
        transition: background-color 0.3s;
      }

      #themeToggle {
        background-color: var(--color-text-light);
      }

      h1 {
        font-weight: 700;
        color: var(--color-primary);
        margin: 0;
      }

      h2,
      h3,
      h4 {
        font-weight: 600;
        margin-top: 20px; /* Ajuste vertical */
        margin-bottom: 15px;
        color: var(--color-text-dark);
      }

      /* Estilos das Abas */
      .tabs {
        display: flex;
        margin-bottom: 0;
        border-bottom: 2px solid #eeeeee;
      }

      .tab-button {
        padding: 12px 25px;
        cursor: pointer;
        border: none;
        border-radius: 8px 8px 0 0;
        background-color: #e0e0e0;
        color: var(--color-text-light);
        font-weight: 500;
        transition: all 0.3s;
        margin-right: 5px;
      }

      .tab-button.active {
        background-color: var(--color-card);
        border-top: 3px solid var(--color-primary);
        border-left: 1px solid #e0e0e0;
        border-right: 1px solid #e0e0e0;
        color: var(--color-primary);
        font-weight: 700;
        margin-bottom: -1px;
      }

      .tab-content {
        background: var(--color-card);
        padding: 30px;
        border: 1px solid #e0e0e0;
        border-radius: 0 8px 8px 8px;
        min-height: 500px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }

      .hidden {
        display: none;
      }

      /* Estilos de Formulário */
      .form-group {
        margin-bottom: 20px;
        padding: 0; /* Limpar padding indesejado */
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 0.9em;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 10px;
        border: 1px solid #cccccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1em;
      }

      .submit-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
      }

      .submit-btn:hover {
        opacity: 0.9;
      }

      /* Estilos de Tabela e Ações */
      table {
        width: 100%;
        margin-top: 25px;
        border-radius: 8px;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eeeeee;
      }

      th {
        background-color: var(--color-primary);
        color: white;
        font-weight: 600;
        font-size: 0.85em;
      }

      tr:nth-child(even) {
        background-color: var(--color-table-stripe);
      }

      .action-btns button {
        margin-right: 5px;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 0.85em;
      }

      /* Pedidos: Lista de Itens */
      .selected-products-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .selected-products-list li {
        padding: 8px 0;
        border-bottom: 1px dotted #d5d5d5;
      }

      /* Área de Cadastro Rápido (para melhor visualização) */
      #quickClientForm {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
      }

      /* Campo de Quantidade na Edição */
      .quantity-control {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .quantity-control input {
        width: 50px;
        text-align: center;
        padding: 5px;
        height: auto;
      }
      .quantity-control button {
        width: 30px;
        height: 30px;
        padding: 0;
        font-size: 1.2em;
        border-radius: 5px;
        background-color: #ddd;
        color: var(--color-text-dark);
        border: 1px solid #ccc;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>Gerenciamento de Pedidos</h1>
      <div>
        <button id="themeToggle">Trocar Tema</button>
        <button id="logoutButton">Sair</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab-button active" data-tab="products">Produtos</div>
      <div class="tab-button" data-tab="orders">Pedidos</div>
      <div class="tab-button" data-tab="clients">Clientes</div>
    </div>

    <div id="products-content" class="tab-content">
      <h2>Cardápio</h2>
      <div id="product-message" class="message-status hidden"></div>

      <h3>Novo Item / Editar (<span id="product-form-mode">Criar</span>)</h3>
      <form id="productForm">
        <input type="hidden" id="product-id" />
        <div class="form-group">
          <label for="product-name">Nome:</label>
          <input type="text" id="product-name" required />
        </div>
        <div class="form-group">
          <label for="product-category">Categoria:</label>
          <select id="product-category" required>
            <option value="">Selecione a Categoria</option>
            <option value="1">Sanduíches</option>
            <option value="2">Bebidas</option>
          </select>
        </div>
        <div class="form-group">
          <label for="product-price">Preço (R$):</label>
          <input type="number" id="product-price" step="0.01" required />
        </div>
        <button type="submit" class="submit-btn" id="product-submit-btn">
          Criar Produto
        </button>
        <button
          type="button"
          class="submit-btn delete-btn hidden"
          id="product-cancel-btn"
        >
          Cancelar Edição
        </button>
      </form>

      <h3>Lista Atual</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Categoria</th>
            <th>Preço</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="productsBody">
          <tr>
            <td colspan="5">Carregando produtos...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="orders-content" class="tab-content hidden">
      <h2>Gerenciar Pedidos</h2>
      <div id="order-message" class="message-status hidden"></div>

      <h3>Criar Novo Pedido</h3>

      <form id="quickClientForm">
        <h4>Registro Rápido de Cliente</h4>
        <div id="quickClientMessage" class="message-status hidden"></div>
        <div class="form-group">
          <label for="quick-client-nome">Nome do Cliente:</label>
          <input type="text" id="quick-client-nome" required />
        </div>
        <div class="form-group">
          <label for="quick-client-email">E-mail do Cliente:</label>
          <input type="email" id="quick-client-email" required />
        </div>
        <button
          type="submit"
          class="submit-btn"
          style="background-color: var(--color-info)"
        >
          + Cadastrar Cliente
        </button>
      </form>

      <form id="orderForm">
        <div class="form-group">
          <label for="order-client">Cliente:</label>
          <select id="order-client" required>
            <option value="">Selecione um Cliente (Nome)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Produtos do Cardápio (Clique para adicionar):</label>
          <div
            id="availableProductsList"
            style="
              border: 1px solid #cccccc;
              padding: 10px;
              height: 100px;
              overflow-y: scroll;
              border-radius: 8px;
            "
          ></div>
        </div>

        <div class="form-group">
          <label>Itens Adicionados ao Pedido:</label>
          <ul id="selectedProductsList" class="selected-products-list">
            <li>Nenhum produto selecionado.</li>
          </ul>
        </div>

        <button type="submit" class="submit-btn">Finalizar Pedido</button>
      </form>

      <h3>Lista de Pedidos Existentes</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Data/Hora</th>
            <th>Cliente</th>
            <th>Itens</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr>
            <td colspan="5">Carregando pedidos...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="clients-content" class="tab-content hidden">
      <h2>Gestão de Clientes</h2>
      <div id="client-message" class="message-status hidden"></div>

      <form id="clientForm">
        <h3>
          Novo / Editar Cliente (<span id="client-form-mode">Criar</span>)
        </h3>
        <input type="hidden" id="client-id" />
        <div class="form-group">
          <label for="client-name">Nome:</label>
          <input type="text" id="client-name" required />
        </div>
        <div class="form-group">
          <label for="client-email">E-mail:</label>
          <input type="email" id="client-email" required />
        </div>
        <button type="submit" class="submit-btn" id="client-submit-btn">
          Criar Cliente
        </button>
        <button
          type="button"
          class="submit-btn delete-btn hidden"
          id="client-cancel-btn"
        >
          Cancelar Edição
        </button>
      </form>

      <h3>Lista de Clientes (Clique no ID para ver Pedidos)</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="clientsBody">
          <tr>
            <td colspan="4">Carregando clientes...</td>
          </tr>
        </tbody>
      </table>

      <div
        id="clientOrdersArea"
        class="hidden"
        style="
          margin-top: 30px;
          border-top: 2px solid #e0e0e0;
          padding-top: 20px;
        "
      >
        <h3>Pedidos de: <span id="selectedClientId"></span></h3>
        <div id="clientOrderMessage" class="message-status hidden"></div>

        <table>
          <thead>
            <tr>
              <th>ID do Pedido</th>
              <th>Data/Hora</th>
              <th>Itens</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="clientOrdersBody">
            <tr>
              <td colspan="4">Selecione um cliente acima.</td>
            </tr>
          </tbody>
        </table>

        <h4 style="margin-top: 20px">
          Editar Pedido Selecionado (<span id="editingOrderId">Nenhum</span>)
        </h4>
        <form
          id="editOrderForm"
          class="hidden"
          style="
            border: 1px solid #eeeeee;
            padding: 15px;
            border-radius: 8px;
            background-color: #fafafa;
          "
        >
          <input type="hidden" id="edit-order-id" />

          <div class="form-group">
            <label for="edit-order-client">Mudar Cliente do Pedido:</label>
            <select id="edit-order-client" required></select>
          </div>

          <div class="form-group">
            <label>Itens Atuais (Qtd. e [Remover]):</label>
            <ul
              id="currentOrderProductsList"
              class="selected-products-list"
            ></ul>
          </div>

          <div class="form-group">
            <label
              >Adicionar Produtos do Cardápio (Clique para adicionar):</label
            >
            <div
              id="availableProductsListForEdit"
              style="
                border: 1px solid #cccccc;
                padding: 10px;
                height: 80px;
                overflow-y: scroll;
                border-radius: 8px;
              "
            >
              Carregando cardápio...
            </div>
          </div>

          <p
            style="
              color: var(--color-text-light);
              font-size: 0.9em;
              margin-top: 10px;
            "
          >
            *As alterações substituirão a lista original no Back-end.
          </p>
          <button type="submit" class="submit-btn edit-btn">
            Salvar Alterações
          </button>
          <button
            type="button"
            class="submit-btn delete-btn"
            id="cancelEditOrder"
          >
            Cancelar Edição
          </button>
        </form>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/api";
      const token = localStorage.getItem("auth_token");

      if (!token) {
        alert("Sessão expirada ou acesso negado! Faça login novamente.");
        window.location.href = "index.html";
      }

      let availableProducts = [];
      let selectedProducts = []; 
      let editingOrderProducts = []; 
      let allClients = []; 
      let currentEditingOrderId = null;
      const CLIENT_ENDPOINT = "clientes";

      // --- Funções de Tema Escuro ---
      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.body.setAttribute("data-theme", savedTheme);

        $("themeToggle").addEventListener("click", () => {
          const currentTheme = document.body.getAttribute("data-theme");
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          document.body.setAttribute("data-theme", newTheme);
          localStorage.setItem("theme", newTheme);
        });
      });

      // --- Variáveis de DOM e Helpers ---
      const $ = (id) => document.getElementById(id);
      const tabs = document.querySelectorAll(".tab-button");
      const contents = document.querySelectorAll(".tab-content");

      // --- Funções Genéricas de API ---
      async function apiRequest(endpoint, method = "GET", data = null) {
        const options = {
          method: method,
          headers: {
            Token: token,
            "Content-Type": "application/json",
          },
        };
        if (data) {
          options.body = JSON.stringify(data);
        }

        const response = await fetch(`${API_URL}/${endpoint}`, options);
        const responseData = await response.json().catch(() => ({}));

        if (response.status === 401) {
          alert("Sessão expirada. Por favor, faça login novamente.");
          localStorage.removeItem("auth_token");
          window.location.href = "index.html";
          throw new Error("Unauthorized");
        }

        if (!response.ok) {
          const errorMessage =
            responseData.error ||
            `Erro desconhecido: Status ${response.status}`;
          throw new Error(errorMessage);
        }

        return responseData;
      }

      // --- Mensagens de Status ---
      function displayMessage(elemId, msg, isSuccess = true) {
        const elem = $(elemId);
        elem.textContent = msg;
        elem.className = "message-status";
        elem.classList.add(isSuccess ? "success" : "error");
        elem.classList.remove("hidden");
        setTimeout(() => elem.classList.add("hidden"), 5000);
      }

      // --- 1. Lógica do Logout e Abas ---
      $("logoutButton").addEventListener("click", () => {
        localStorage.removeItem("auth_token");
        window.location.href = "index.html";
      });

      tabs.forEach((button) => {
        button.addEventListener("click", () => {
          const target = button.getAttribute("data-tab");

          tabs.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");

          contents.forEach((content) => content.classList.add("hidden"));
          $(`${target}-content`).classList.remove("hidden");

          if (target === "products") loadProducts();
          if (target === "orders") {
            loadOrders();
            loadOrderFormDependencies();
            $("quickClientMessage").classList.add("hidden");
          }
          if (target === "clients") {
            loadClients();
            $("clientForm").reset();
            $("client-id").value = "";
            $("client-form-mode").textContent = "Criar";
            $("client-submit-btn").textContent = "Criar Cliente";
            $("client-cancel-btn").classList.add("hidden");
          }
        });
      });

      // --- 2. CRUD de Produtos ---
      async function loadProducts() {
        $("productsBody").innerHTML =
          '<tr><td colspan="5">Carregando produtos...</td></tr>';
        try {
          const products = await apiRequest("produtos");
          availableProducts = products;
          renderProducts(products);
        } catch (error) {
          $(
            "productsBody"
          ).innerHTML = `<tr><td colspan="5" class="error-message">${error.message}</td></tr>`;
        }
      }

      function renderProducts(products) {
        $("productsBody").innerHTML = "";
        if (products.length === 0) {
          $("productsBody").innerHTML =
            '<tr><td colspan="5" style="text-align: center;">Nenhum produto cadastrado.</td></tr>';
          return;
        }

        products.forEach((product) => {
          const row = $("productsBody").insertRow();
          const categoryName = product.categoria
            ? product.categoria.nome
            : "N/A";

          row.insertCell().textContent = product.id;
          row.insertCell().textContent = product.nome;
          row.insertCell().textContent = categoryName;
          row.insertCell().textContent = `R$ ${parseFloat(
            product.preco
          ).toFixed(2)}`;

          const actionsCell = row.insertCell();
          actionsCell.className = "action-btns";

          const editBtn = document.createElement("button");
          editBtn.textContent = "Editar";
          editBtn.className = "edit-btn";
          editBtn.onclick = () => loadProductForEdit(product);
          actionsCell.appendChild(editBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Deletar";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = () => deleteProduct(product.id);
          actionsCell.appendChild(deleteBtn);
        });
      }

      $("productForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = $("product-id").value;
        const nome = $("product-name").value;
        const preco = parseFloat($("product-price").value);
        const categoriaId = parseInt($("product-category").value);

        const payload = {
          nome,
          preco,
          categoria: { id: categoriaId },
        };

        const method = id ? "PUT" : "POST";
        const endpoint = id ? `produtos/${id}` : "produtos";
        const action = id ? "Atualizado" : "Criado";

        try {
          await apiRequest(endpoint, method, payload);
          displayMessage(
            "product-message",
            `Produto ${action} com sucesso!`,
            true
          );

          $("productForm").reset();
          $("product-id").value = "";
          $("product-form-mode").textContent = "Criar";
          $("product-submit-btn").textContent = "Criar Produto";
          $("product-cancel-btn").classList.add("hidden");

          loadProducts();
        } catch (error) {
          displayMessage(
            "product-message",
            `Erro ao ${action.toLowerCase()}: ${error.message}`,
            false
          );
        }
      });

      async function deleteProduct(id) {
        if (!confirm(`Tem certeza que deseja deletar o produto ID ${id}?`))
          return;

        try {
          await apiRequest(`produtos/${id}`, "DELETE");
          displayMessage(
            "product-message",
            `Produto ID ${id} deletado com sucesso!`,
            true
          );
          loadProducts();
        } catch (error) {
          displayMessage(
            "product-message",
            `Erro ao deletar produto: ${error.message}`,
            false
          );
        }
      }

      function loadProductForEdit(product) {
        $("product-id").value = product.id;
        $("product-name").value = product.nome;
        $("product-price").value = product.preco;
        $("product-category").value = product.categoria
          ? product.categoria.id
          : "";

        $("product-form-mode").textContent = "Editar";
        $("product-submit-btn").textContent = "Salvar Alterações";
        $("product-cancel-btn").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      $("product-cancel-btn").addEventListener("click", () => {
        $("productForm").reset();
        $("product-id").value = "";
        $("product-form-mode").textContent = "Criar";
        $("product-submit-btn").textContent = "Criar Produto";
        $("product-cancel-btn").classList.add("hidden");
      });

      // --- 3. CRUD de Pedidos ---

      // Lógica de Cadastro Rápido de Cliente
      $("quickClientForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const nome = $("quick-client-nome").value;
        const email = $("quick-client-email").value;

        const payload = { nome, email };

        try {
          await apiRequest(CLIENT_ENDPOINT, "POST", payload);

          displayMessage(
            "quickClientMessage",
            `Cliente ${nome} cadastrado com sucesso! Recarregando lista...`,
            true
          );

          $("quickClientForm").reset();
          await loadOrderFormDependencies();
        } catch (error) {
          displayMessage(
            "quickClientMessage",
            `Erro ao cadastrar cliente: ${error.message}`,
            false
          );
        }
      });

      // READ (Listar Pedidos)
      async function loadOrders() {
        $("ordersBody").innerHTML =
          '<tr><td colspan="5">Carregando pedidos...</td></tr>';
        try {
          const orders = await apiRequest("pedidos");
          renderOrders(orders);
        } catch (error) {
          $(
            "ordersBody"
          ).innerHTML = `<tr><td colspan="5" class="error-message">${error.message}</td></tr>`;
        }
      }

      function renderOrders(orders) {
        $("ordersBody").innerHTML = "";
        if (orders.length === 0) {
          $("ordersBody").innerHTML =
            '<tr><td colspan="5" style="text-align: center;">Nenhum pedido cadastrado.</td></tr>';
          return;
        }

        orders.forEach(order => {
        const row = $('ordersBody').insertRow();
        const clientName = order.cliente
            ? (order.cliente.nome || order.cliente.email || `ID: ${order.cliente.id}`)
            : 'N/A';
        const productCount = order.listaProdutos ? order.listaProdutos.length : 0; 
        const formattedDate = new Date(order.dataHora).toLocaleString('pt-BR');

        row.insertCell().textContent = order.id.substring(0, 8) + '...';
        row.insertCell().textContent = formattedDate;
        row.insertCell().textContent = clientName; 
        row.insertCell().textContent = productCount;

        const actionsCell = row.insertCell();
        actionsCell.className = 'action-btns';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Editar';
        editBtn.className = 'edit-btn';
        editBtn.onclick = () => {
            tabs.forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-tab="clients"]').classList.add('active');
            
            contents.forEach(content => content.classList.add('hidden'));
            $('clients-content').classList.remove('hidden');

            showClientOrders(order.cliente.id, clientName); 
        };
        actionsCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Deletar';
        deleteBtn.className = 'delete-btn';
        deleteBtn.onclick = () => deleteOrder(order.id);
        actionsCell.appendChild(deleteBtn);
    });
}

      // DELETE (Deletar Pedido)
      async function deleteOrder(id) {
        if (!confirm(`Tem certeza que deseja deletar o pedido ID ${id}?`))
          return;

        try {
          await apiRequest(`pedidos/${id}`, "DELETE");
          displayMessage(
            "order-message",
            `Pedido ID ${id} deletado com sucesso!`,
            true
          );
          loadOrders();
        } catch (error) {
          displayMessage(
            "order-message",
            `Erro ao deletar pedido: ${error.message}`,
            false
          );
        }
      }

      async function loadOrderFormDependencies() {
        await loadProducts();

        try {
          const clients = await apiRequest(CLIENT_ENDPOINT);
          allClients = clients; // Salva todos os clientes
          const selectClient = $("order-client");

          selectClient.innerHTML =
            '<option value="">Selecione um Cliente (Nome)</option>';

          clients.forEach((client) => {
            const option = document.createElement("option");
            option.value = client.id;
            const clientName = client.nome || client.email;
            option.textContent = `${clientName} (ID: ${client.id})`;
            selectClient.appendChild(option);
          });
        } catch (error) {
          displayMessage(
            "order-message",
            `Erro ao carregar clientes: ${error.message}`,
            false
          );
        }

        renderAvailableProducts();
        renderSelectedProducts();
      }

      function renderAvailableProducts() {
        const listContainer = $("availableProductsList");
        listContainer.innerHTML = "";

        if (availableProducts.length === 0) {
          listContainer.innerHTML =
            "<p>Nenhum produto disponível. Cadastre na aba Produtos.</p>";
          return;
        }

        availableProducts.forEach((product) => {
          const item = document.createElement("div");
          item.className = "product-item";
          item.setAttribute("data-id", product.id);
          item.textContent = `${product.nome} (R$ ${parseFloat(
            product.preco
          ).toFixed(2)})`;
          item.onclick = () => addProductToOrder(product);
          listContainer.appendChild(item);
        });
      }

      function addProductToOrder(product) {
        selectedProducts.push({ id: product.id, nome: product.nome });
        renderSelectedProducts();
      }

      function removeProductFromOrder(index) {
        selectedProducts.splice(index, 1);
        renderSelectedProducts();
      }

      function renderSelectedProducts() {
        const list = $("selectedProductsList");
        list.innerHTML = "";

        if (selectedProducts.length === 0) {
          list.innerHTML = "<li>Nenhum produto selecionado.</li>";
          return;
        }

        // Simplificação para exibição: agrupa itens, mas o array 'selectedProducts' contém todas as instâncias
        const itemCounts = selectedProducts.reduce((acc, item) => {
          acc[item.id] = (acc[item.id] || 0) + 1;
          return acc;
        }, {});

        const uniqueItems = Array.from(
          new Set(selectedProducts.map((p) => p.id))
        ).map((id) => availableProducts.find((p) => p.id === id));

        uniqueItems.forEach((product) => {
          const count = itemCounts[product.id];
          const li = document.createElement("li");
          li.innerHTML = `${count}x ${product.nome} 
                                <span class="remove-product" data-id="${product.id}" style="color: var(--color-text-dark);">[Qtd: ${count}]</span>`;
          list.appendChild(li);
        });
      }

      // CREATE (Fazer Pedido - POST)
      $("orderForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const clienteId = parseInt($("order-client").value);

        if (!clienteId) {
          displayMessage(
            "order-message",
            "Selecione um cliente para fazer o pedido.",
            false
          );
          return;
        }

        if (selectedProducts.length === 0) {
          displayMessage(
            "order-message",
            "Adicione pelo menos um produto ao pedido.",
            false
          );
          return;
        }

        const payload = {
          cliente: { id: clienteId },
          // Envia a lista completa de IDs (duplicados, se houver)
          listaProdutos: selectedProducts.map((p) => ({ id: p.id })),
        };

        try {
          await apiRequest("pedidos", "POST", payload);
          displayMessage("order-message", "Pedido criado com sucesso!", true);

          $("orderForm").reset();
          selectedProducts = [];
          renderSelectedProducts();
          loadOrders();
        } catch (error) {
          displayMessage(
            "order-message",
            `Erro ao criar pedido: ${error.message}`,
            false
          );
        }
      });

      // --- 4. CRUD de Clientes (CRUD Completo e Visualização de Pedidos) ---

      // CRUD de Cliente (Inserir / Atualizar)
      $("clientForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = $("client-id").value;
        const nome = $("client-name").value;
        const email = $("client-email").value;

        const payload = { nome, email };
        const method = id ? "PUT" : "POST";
        const endpoint = id ? `${CLIENT_ENDPOINT}/${id}` : CLIENT_ENDPOINT;
        const action = id ? "Atualizado" : "Criado";

        try {
          await apiRequest(endpoint, method, payload);
          displayMessage(
            "client-message",
            `Cliente ${action} com sucesso!`,
            true
          );

          // Limpar formulário
          $("clientForm").reset();
          $("client-id").value = "";
          $("client-form-mode").textContent = "Criar";
          $("client-submit-btn").textContent = "Criar Cliente";
          $("client-cancel-btn").classList.add("hidden");

          loadClients();
        } catch (error) {
          displayMessage(
            "client-message",
            `Erro ao ${action.toLowerCase()}: ${error.message}`,
            false
          );
        }
      });

      async function deleteClient(id) {
        if (
          !confirm(
            `Tem certeza que deseja deletar o cliente ID ${id}? Isso pode falhar se existirem pedidos associados.`
          )
        )
          return;

        try {
          await apiRequest(`${CLIENT_ENDPOINT}/${id}`, "DELETE");
          displayMessage(
            "client-message",
            `Cliente ID ${id} deletado com sucesso!`,
            true
          );
          loadClients();
        } catch (error) {
          displayMessage(
            "client-message",
            `Erro ao deletar cliente: ${error.message}`,
            false
          );
        }
      }

      function loadClientForEdit(client) {
        $("client-id").value = client.id;
        $("client-name").value = client.nome;
        $("client-email").value = client.email;

        $("client-form-mode").textContent = "Editar";
        $("client-submit-btn").textContent = "Salvar Alterações";
        $("client-cancel-btn").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Listagem de Clientes
      async function loadClients() {
        $("clientOrdersArea").classList.add("hidden");

        $("clientsBody").innerHTML =
          '<tr><td colspan="4">Carregando clientes...</td></tr>';
        try {
          const clients = await apiRequest(CLIENT_ENDPOINT);
          renderClients(clients);
        } catch (error) {
          $(
            "clientsBody"
          ).innerHTML = `<tr><td colspan="4" class="error-message">${error.message}. Verifique se a rota /api/${CLIENT_ENDPOINT} existe.</td></tr>`;
        }
      }

      function renderClients(clients) {
        $("clientsBody").innerHTML = "";
        if (clients.length === 0) {
          $("clientsBody").innerHTML =
            '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
          return;
        }

        clients.forEach((client) => {
          const row = $("clientsBody").insertRow();

          // Coluna 1: ID e clique para ver pedidos
          const idCell = row.insertCell();
          idCell.textContent = client.id;
          idCell.classList.add("clickable-row");
          idCell.onclick = () =>
            showClientOrders(client.id, client.nome || client.email);

          // Coluna 2: Nome
          row.insertCell().textContent = client.nome || "N/A";

          // Coluna 3: E-mail
          row.insertCell().textContent = client.email || "N/A";

          // Coluna 4: Ações (Editar/Deletar)
          const actionsCell = row.insertCell();
          actionsCell.className = "action-btns";

          const editBtn = document.createElement("button");
          editBtn.textContent = "Editar";
          editBtn.className = "edit-btn";
          editBtn.onclick = () => loadClientForEdit(client);
          actionsCell.appendChild(editBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Deletar";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = () => deleteClient(client.id);
          actionsCell.appendChild(deleteBtn);
        });
      }

      // Visualização de Pedidos por Cliente
      async function showClientOrders(clientId, clientName) {
        $("clientOrdersBody").innerHTML =
          '<tr><td colspan="4">Buscando pedidos...</td></tr>';
        $("selectedClientId").textContent = `${clientId} (${clientName})`;
        $("clientOrdersArea").classList.remove("hidden");

        $("editOrderForm").classList.add("hidden");

        try {
          const orders = await apiRequest(`pedidos/cliente/${clientId}`);
          renderClientOrders(orders, clientId, clientName);

          // Preenche a dropdown de clientes para edição de pedidos
          fillEditOrderClientDropdown(clientId);
        } catch (error) {
          $(
            "clientOrdersBody"
          ).innerHTML = `<tr><td colspan="4" class="error-message">
                    Erro ao buscar pedidos: ${error.message}.
                </td></tr>`;
        }
      }

      // Preenche a dropdown de clientes na área de edição de pedidos
      function fillEditOrderClientDropdown(currentClientId) {
        const select = $("edit-order-client");
        select.innerHTML = "";

        allClients.forEach((client) => {
          const option = document.createElement("option");
          option.value = client.id;
          option.textContent = `${client.nome || client.email} (ID: ${
            client.id
          })`;
          if (client.id == currentClientId) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      }

      function renderClientOrders(orders, clientId, clientName) {
        $("clientOrdersBody").innerHTML = "";
        if (orders.length === 0) {
          $("clientOrdersBody").innerHTML =
            '<tr><td colspan="4" style="text-align: center;">Nenhum pedido encontrado para este cliente.</td></tr>';
          return;
        }

        orders.forEach((order) => {
          const row = $("clientOrdersBody").insertRow();

          const productCount = order.listaProdutos
            ? order.listaProdutos.length
            : 0;
          const formattedDate = new Date(order.dataHora).toLocaleString(
            "pt-BR"
          );

          row.insertCell().textContent = order.id.substring(0, 8) + "...";
          row.insertCell().textContent = formattedDate;
          row.insertCell().textContent = productCount;

          const actionsCell = row.insertCell();
          actionsCell.className = "action-btns";

          const editBtn = document.createElement("button");
          editBtn.textContent = "Editar";
          editBtn.className = "edit-btn";
          editBtn.onclick = () => loadOrderForEdit(order);
          actionsCell.appendChild(editBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Deletar";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = async () => {
            if (
              !confirm(
                `Tem certeza que deseja deletar o pedido ID ${order.id.substring(
                  0,
                  8
                )}...?`
              )
            )
              return;
            try {
              await apiRequest(`pedidos/${order.id}`, "DELETE");
              displayMessage(
                "clientOrderMessage",
                `Pedido ID ${order.id.substring(0, 8)} deletado com sucesso!`,
                true
              );
              showClientOrders(clientId, clientName);
            } catch (error) {
              displayMessage(
                "clientOrderMessage",
                `Erro ao deletar pedido: ${error.message}`,
                false
              );
            }
          };
          actionsCell.appendChild(deleteBtn);
        });
      }

      // --- Lógica de Edição de Pedido de Cliente (CRUD Completo na UI) ---

      function renderCurrentOrderProducts() {
        const list = $("currentOrderProductsList");
        list.innerHTML = "";

        if (editingOrderProducts.length === 0) {
          list.innerHTML = "<li>Nenhum produto selecionado.</li>";
          return;
        }

        // Agrupa os produtos e calcula a quantidade
        const groupedProducts = editingOrderProducts.reduce((acc, product) => {
          if (acc[product.id]) {
            acc[product.id].count += 1;
          } else {
            acc[product.id] = { ...product, count: 1 };
          }
          return acc;
        }, {});

        // Renderiza os produtos agrupados com controle de quantidade
        Object.values(groupedProducts).forEach((product) => {
          const li = document.createElement("li");
          li.style.display = "flex";
          li.style.justifyContent = "space-between";
          li.style.alignItems = "center";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = product.nome;

          const controlDiv = document.createElement("div");
          controlDiv.classList.add("quantity-control");

          // Botão de Diminuir
          const minusBtn = document.createElement("button");
          minusBtn.textContent = "-";
          minusBtn.type = "button";
          minusBtn.onclick = () => updateProductQuantity(product.id, -1);

          // Input de Quantidade (apenas para visualização)
          const countInput = document.createElement("input");
          countInput.type = "number";
          countInput.min = "1";
          countInput.value = product.count;
          countInput.readOnly = true;

          // Botão de Aumentar
          const plusBtn = document.createElement("button");
          plusBtn.textContent = "+";
          plusBtn.type = "button";
          plusBtn.onclick = () => updateProductQuantity(product.id, 1);

          // Adiciona [X Remover Tudo] (se a contagem for 1)
          const removeAllSpan = document.createElement("span");
          removeAllSpan.textContent = "[X Remover Tudo]";
          removeAllSpan.classList.add("remove-product");
          removeAllSpan.onclick = () =>
            removeProductQuantity(product.id, product.count);

          controlDiv.appendChild(minusBtn);
          controlDiv.appendChild(countInput);
          controlDiv.appendChild(plusBtn);
          controlDiv.appendChild(removeAllSpan);

          li.appendChild(nameSpan);
          li.appendChild(controlDiv);
          list.appendChild(li);
        });
      }

      // --- FUNÇÕES DE CONTROLE DE QUANTIDADE NA EDIÇÃO ---

      function updateProductQuantity(productId, delta) {
        const index = editingOrderProducts.findIndex((p) => p.id === productId);

        if (delta > 0) {
          // Aumentar: Adiciona uma nova instância do produto
          const product = availableProducts.find((p) => p.id === productId);
          if (product) {
            editingOrderProducts.push({ id: product.id, nome: product.nome });
          }
        } else if (delta < 0) {
          // Diminuir: Remove uma instância do produto
          if (index !== -1) {
            editingOrderProducts.splice(index, 1);
          }
        }
        renderCurrentOrderProducts();

        // Se o último item foi removido, fecha o formulário
        if (editingOrderProducts.length === 0) {
          $("editOrderForm").classList.add("hidden");
        }
      }

      function removeProductQuantity(productId, count) {
        // Remove todas as instâncias deste produto
        editingOrderProducts = editingOrderProducts.filter(
          (p) => p.id !== productId
        );
        renderCurrentOrderProducts();

        if (editingOrderProducts.length === 0) {
          $("editOrderForm").classList.add("hidden");
        }
      }


      function renderAvailableProductsForEdit() {
        const listContainer = $("availableProductsListForEdit");
        listContainer.innerHTML = "";

        if (availableProducts.length === 0) {
          listContainer.innerHTML =
            "<p>Nenhum produto disponível. Cadastre na aba Produtos.</p>";
          return;
        }

        availableProducts.forEach((product) => {
          const item = document.createElement("div");
          item.className = "product-item";
          item.textContent = `${product.nome} (R$ ${parseFloat(
            product.preco
          ).toFixed(2)})`;
          item.onclick = () => {
            // Ao clicar, adiciona uma nova instância (Qtd +1)
            editingOrderProducts.push({ id: product.id, nome: product.nome });
            renderCurrentOrderProducts();
          };
          listContainer.appendChild(item);
        });
      }

      async function loadOrderForEdit(order) {
        currentEditingOrderId = order.id;
        // Carrega a lista completa de produtos (incluindo duplicatas) para a edição
        editingOrderProducts = order.listaProdutos.map((p) => ({
          id: p.id,
          nome: p.nome,
        }));

        $("edit-order-id").value = order.id;
        $("editingOrderId").textContent = order.id.substring(0, 8) + "...";
        $("editOrderForm").classList.remove("hidden");

        // Seleciona o cliente correto na dropdown
        if (order.cliente && order.cliente.id) {
          $("edit-order-client").value = order.cliente.id;
        }

        renderCurrentOrderProducts();
        renderAvailableProductsForEdit();

        window.scrollTo({ top: 0, behavior: "smooth" }); // Rola para o topo para edição
      }

      $("editOrderForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const orderId = $("edit-order-id").value;
        const newClientId = parseInt($("edit-order-client").value);

        if (editingOrderProducts.length === 0) {
          displayMessage(
            "clientOrderMessage",
            "O pedido deve ter pelo menos um produto.",
            false
          );
          return;
        }
        if (!newClientId) {
          displayMessage(
            "clientOrderMessage",
            "Selecione um cliente válido para o pedido.",
            false
          );
          return;
        }

        // O Front-end agora permite mudar o cliente
        const newClientObject = allClients.find(
          (c) => c.id === newClientId
        ) || { id: newClientId };

        const payload = {
          cliente: newClientObject,
          // Lista de produtos é a lista editada
          listaProdutos: editingOrderProducts.map((p) => ({ id: p.id })),
        };

        try {
          await apiRequest(`pedidos/${orderId}`, "PUT", payload);
          displayMessage(
            "clientOrderMessage",
            `Pedido ID ${orderId.substring(0, 8)} atualizado com sucesso!`,
            true
          );

          const clientName =
            newClientObject.nome || newClientObject.email || "Cliente";
          showClientOrders(newClientId, clientName);

          $("editOrderForm").classList.add("hidden");
          currentEditingOrderId = null;
          editingOrderProducts = [];
        } catch (error) {
          displayMessage(
            "clientOrderMessage",
            `Erro ao atualizar pedido: ${error.message}`,
            false
          );
        }
      });

      $("cancelEditOrder").addEventListener("click", () => {
        $("editOrderForm").classList.add("hidden");
        currentEditingOrderId = null;
        editingOrderProducts = [];
      });

      loadProducts();
    </script>
  </body>
</html>
